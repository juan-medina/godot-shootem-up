name: release

on:
  release:
    types: [created]

permissions:
  contents: write
  packages: write

jobs:
  Godot:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [ windows ]
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          lfs: true

      - name: Build
        id: build
        uses: felix-schindler/build-godot-action@v2.0.0
        with:
          name: shoot_em_up
          preset: ${{ matrix.platform }}
          debugMode: "false"

      - name: Install Wine
        run: |
          sudo dpkg --add-architecture i386
          sudo apt update
          sudo apt install -y wine32

      - name: Download rcedit
        run: |
          wget https://github.com/electron/rcedit/releases/download/v2.0.0/rcedit-x86.exe

      - name: Modify Executable with rcedit
        run: |
          wine rcedit-x86 build/shoot_em_up.exe \
              --set-icon resources/icon/juan_medina.ico \
              --set-file-version "${{ github.event.release.name }}" \
              --set-product-version "${{ github.event.release.name }}" \
              --set-version-string "FileDescription" "Shoot 'em up in Godot 4" \
              --set-version-string "ProductName" "Shoot 'em up" \
              --set-version-string "CompanyName" "Juan Medina" \
              --set-version-string "LegalCopyright" "(c) 2024 Juan Medina"

      - name: Re-zip modified build artifact
        run: |
          cd build
          zip -r shoot_em_up.zip shoot_em_up.exe shoot_em_up.pck

      - name: Add zip to the release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/shoot_em_up.zip
          asset_name: "shoot_em_up-${{ github.event.release.name }}-${{ matrix.platform }}.zip"
          tag: ${{ github.ref }}
          overwrite: true
